"use strict";var _createClass=function(){function a(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();require("babel-polyfill"),require("gm-base64");var _bluebird=require("bluebird"),_bluebird2=_interopRequireDefault(_bluebird),_gm=require("gm"),_gm2=_interopRequireDefault(_gm),_path=require("path"),_path2=_interopRequireDefault(_path),_fsExtra=require("fs-extra"),_fsExtra2=_interopRequireDefault(_fsExtra),_helper=require("./helper"),_helper2=_interopRequireDefault(_helper);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new _bluebird2.default(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):_bluebird2.default.resolve(h).then(function(a){d("next",a)},function(a){d("throw",a)})}return d("next")})}}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var Private=(0,_helper2.default)(),PDF2Pic=function(){function a(b){var c=this;_classCallCheck(this,a),Private(this).quality=0,Private(this).format=b.format||"png",Private(this).size=b.size||"768x512",Private(this).density=b.density||72,Private(this).savedir=b.savedir||void 0,Private(this).savename=b.savename||void 0,Private(this).compression=b.compression||"jpeg",Private(this).gm=!0===b.imageMagick?_gm2.default.subClass({imageMagick:!0}):_gm2.default,Private(this).identify=function(a){var b=1<arguments.length&&void 0!==arguments[1]?arguments[1]:void 0,d=Private(c).gm(a);return new _bluebird2.default(function(a,c){b?d.identify(b,function(b,d){return b?c(b):a(d)}):d.identify(function(b,d){return b?c(b):a(d)})})},Private(this).writeImage=function(a,b,d,e){return new _bluebird2.default(function(f,g){Private(c).gm(a,d).density(Private(c).density,Private(c).density).resize(Private(c).size).quality(Private(c).quality).compress(Private(c).compression).write(b,function(a){return a?g(a):f({name:_path2.default.basename(b),size:_fsExtra2.default.statSync(b).size/1e3,path:b,page:e})})})},Private(this).toBase64=function(a,b,d){return new _bluebird2.default(function(e,f){Private(c).gm(a,b).density(Private(c).density,Private(c).density).resize(Private(c).size).quality(Private(c).quality).compress(Private(c).compression).toBase64(Private(c).format,function(a,b){return a?f(a):e({base64:b,page:d})})})}}return _createClass(a,[{key:"convert",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return this.isValidPDF(b),this.fileExists(b),c=_path2.default.basename(b,_path2.default.extname(_path2.default.basename(b))),this.get("savedir")?this.set("savedir",this.get("savedir")+_path2.default.sep):this.set("savedir",c+_path2.default.sep),_fsExtra2.default.mkdirsSync(this.get("savedir")),this.get("savename")||this.set("savename",c),a.next=8,this.getPageCount(b);case 8:if(d=a.sent,!(e>d)){a.next=11;break}throw{error:"InvalidPageSelection",message:"Cannot convert non-existent page"};case 11:return a.next=13,this.toImage(b,e);case 13:return a.abrupt("return",a.sent);case 14:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"convertToBase64",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return this.isValidPDF(b),this.fileExists(b),c=_path2.default.basename(b,_path2.default.extname(_path2.default.basename(b))),this.get("savedir")?this.set("savedir",this.get("savedir")+_path2.default.sep):this.set("savedir",c+_path2.default.sep),_fsExtra2.default.mkdirsSync(this.get("savedir")),this.get("savename")||this.set("savename",c),a.next=8,this.getPageCount(b);case 8:if(d=a.sent,!(e>d)){a.next=11;break}throw{error:"InvalidPageSelection",message:"Cannot convert non-existent page"};case 11:return a.next=13,this.toBase64(b,e,!0);case 13:return a.abrupt("return",a.sent);case 14:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"convertToBase64Bulk",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=[],-1!==d){a.next=7;break}return a.next=4,this.getPage(b);case 4:a.t0=a.sent,a.next=8;break;case 7:a.t0=Array.isArray(d)?d:[1];case 8:return d=a.t0,a.next=11,_bluebird2.default.each(d,function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(d){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=c,a.next=3,this.convertToBase64(b,d);case 3:a.t1=a.sent,a.t0.push.call(a.t0,a.t1);case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}().bind(this));case 11:return a.abrupt("return",c);case 12:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"convertBulk",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(c=[],-1!==d){a.next=7;break}return a.next=4,this.getPage(b);case 4:a.t0=a.sent,a.next=8;break;case 7:a.t0=Array.isArray(d)?d:[1];case 8:return d=a.t0,a.next=11,_bluebird2.default.each(d,function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(d){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.t0=c,a.next=3,this.convert(b,d);case 3:a.t1=a.sent,a.t0.push.call(a.t0,a.t1);case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}().bind(this));case 11:return a.abrupt("return",c);case 12:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPageCount",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,this.getPage(b).length;case 2:return a.abrupt("return",a.sent);case 3:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getPage",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,Private(this).identify(b,"%p ");case 2:return c=a.sent,a.abrupt("return",c.split(" "));case 4:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"toImage",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e,f=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=_fsExtra2.default.createReadStream(b),d=""+this.get("savedir")+this.get("savename")+"_"+f+"."+this.get("format"),e=this.getFilePath(c)+"["+(f-1)+"]",a.next=5,Private(this).writeImage(c,d,e,f);case 5:return a.abrupt("return",a.sent);case 6:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"toBase64",value:function(){var a=_asyncToGenerator(regeneratorRuntime.mark(function a(b){var c,d,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1;return regeneratorRuntime.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c=_fsExtra2.default.createReadStream(b),d=this.getFilePath(c)+"["+(e-1)+"]",a.next=4,Private(this).toBase64(c,d,e);case 4:return a.abrupt("return",a.sent);case 5:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}()},{key:"getFilePath",value:function(a){if(!a)throw{error:"InvalidPath",message:"Invalid Path"};return a.path}},{key:"isValidPDF",value:function(a){if(".pdf"!=_path2.default.extname(_path2.default.basename(a)))throw{error:"InvalidPDF",message:"File supplied is not a valid PDF"};return!0}},{key:"fileExists",value:function(a){if(!_fsExtra2.default.existsSync(a))throw{error:"FileNotFound",message:"File supplied cannot be found"};return!0}},{key:"get",value:function(a){return"[object Function]"==Object.prototype.toString.call(Private(this)[a])?void 0:Private(this)[a]}},{key:"set",value:function(a,b){return void 0!==this.get(a)&&(Private(this)[a]=b),this}}]),a}();module.exports=PDF2Pic;